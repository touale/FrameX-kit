stages:
  - test
  - release
  - deploy

variables:
  # Registry
  CI_TEMPLATE_REGISTRY_HOST: "docker.io"
  APT_SOURCE: "https://mirrors.aliyun.com"
  GITLAB_SOURCE: ""

  # Cache
  PRE_COMMIT_HOME: "$CI_PROJECT_DIR/.pre-commit"
  CARGO_HOME: $CI_PROJECT_DIR/cargo

  # Pip
  PIP_TIMEOUT: 30
  PIP_RETRIES: 5
  PIP_TRUSTED_HOST: ""
  PYPI_URL: https://pypi.org/simple

  # Python & UV
  PYTHON_VERSION: "3.11"
  UV_VERSION: "0.5"
  UV_LINK_MODE: "copy"
  UV_FROZEN: "true"

# â›“ï¸ Shared templates
.base_test_job_template: &base_test_job_template
  stage: test
  retry:
    max: 2
    when:
      - runner_system_failure
  tags:
    - k8s_runner_persionnel_matching
  rules:
    - if: "$CI_COMMIT_MESSAGE =~ /^v/ || $CI_COMMIT_TAG"
      when: never
    - if: "$CI_COMMIT_BRANCH"

.base_git_env_template: &base_git_env_template
  before_script:
    - |
        rm -rf /var/lib/apt/lists/* /etc/apt/sources.list.d && \
        echo "deb $APT_SOURCE/debian/ bookworm main" > /etc/apt/sources.list && \
        echo "deb $APT_SOURCE/debian-security/ bookworm-security main" >> /etc/apt/sources.list && \
        echo "deb $APT_SOURCE/debian/ bookworm-updates main" >> /etc/apt/sources.list && \
        apt-get update -y && apt-get install -y --no-install-recommends git

renovate:
  image: ${CI_TEMPLATE_REGISTRY_HOST}/renovatebot/renovate:full
  stage: test
  variables:
    RENOVATE_PLATFORM: gitlab
    RENOVATE_ENDPOINT: $GITLAB_SOURCE
    RENOVATE_TOKEN: $GITLAB_TOKEN
    LOG_LEVEL: debug
    RENOVATE_REPOSITORIES: "$CI_PROJECT_PATH"
    RENOVATE_CACHE_NPM: "false"
    RENOVATE_CACHE_PIP: "false"
    RENOVATE_PYPI_PASS: "$PYPI_PASS"
  script:
    - renovate
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: '$CI_COMMIT_REF_NAME == "master" || $CI_COMMIT_REF_NAME == "main" || $CI_COMMIT_REF_NAME == "dev"'

# ðŸ”’ Secret scan
include:
  - template: Security/Secret-Detection.gitlab-ci.yml

secret_detection:
  <<: *base_test_job_template
  allow_failure: false
  script:
    - /analyzer run
    - cat gl-secret-detection-report.json

# âœ… Pre-commit check
check-pre-commit:
  <<: *base_test_job_template
  <<: *base_git_env_template
  image: ${CI_TEMPLATE_REGISTRY_HOST}/library/python:3.11-slim
  cache:
    key: ${CI_PROJECT_ID}-pre-commit-cache
    paths:
      - $PRE_COMMIT_HOME
  script:
    - pip install pre-commit==4.2.0 -i $PYPI_URL
    - |
        pre-commit run --all-files --show-diff-on-failure

# ðŸ§ª Project test
test-project:
  <<: *base_test_job_template
  image: ${CI_TEMPLATE_REGISTRY_HOST}/astral-sh/uv:${UV_VERSION}-python${PYTHON_VERSION}-bookworm-slim
  cache:
    key: ${CI_PROJECT_ID}-test-cache
    paths:
      - tests/api/cassettes
  script:
    - uv sync --group dev
    - uv run poe test-ci
  coverage: '/(?i)total.*? (100(?:\.0+)?%|[1-9]?\d(?:\.\d+)?%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: cov.xml
      junit: report.xml

# ðŸš€ Semantic Release
release:
  <<: *base_git_env_template
  image: ${CI_TEMPLATE_REGISTRY_HOST}/astral-sh/uv:${UV_VERSION}-python${PYTHON_VERSION}-bookworm-slim
  stage: release
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: "$CI_COMMIT_MESSAGE =~ /^v/ || $CI_COMMIT_TAG"
      when: never
    - if: '$CI_COMMIT_REF_NAME == "master" || $CI_COMMIT_REF_NAME == "main" || $CI_COMMIT_REF_NAME == "dev"'
  variables:
    GIT_DEPTH: 0
  before_script:
    - !reference [.base_git_env_template, before_script]
    - git checkout -B "$CI_COMMIT_REF_NAME" "origin/$CI_COMMIT_REF_NAME"
    - git status
  script:
    - uv sync --extra release
    - uv run poe release

pages:
  <<: *base_test_job_template
  stage: deploy
  image: ${CI_TEMPLATE_REGISTRY_HOST}/library/rust:latest
  rules:
    - if: '$CI_COMMIT_REF_NAME == "master" || $CI_COMMIT_REF_NAME == "main" || $CI_COMMIT_REF_NAME == "dev"'
      changes:
        - book/**/*
  cache:
    key: ${CI_PROJECT_ID}-pages-cache
    paths:
      - $CARGO_HOME
  before_script:
    - export PATH="$PATH:$CARGO_HOME/bin"
    - cargo install mdbook
    - cargo install mdbook-toc
    - cargo install mdbook-katex
    - cargo install mdbook-last-changed
  script:
    - cd book && mdbook build -d ../public
  artifacts:
    paths:
      - public   
