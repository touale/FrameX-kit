stages:
  - test

variables:
  # ci
  CI_TEMPLATE_REGISTRY_HOST: "docker.io"

  # cache config
  APT_CACHE_DIR: "$CI_PROJECT_DIR/apt"
  KANIKO_CACHE_DIR: "$CI_PROJECT_DIR/kaniko"

  # pip config
  PIP_TIMEOUT: 30
  PIP_RETRIES: 5
  PIP_TRUSTED_HOST: ""

  # uv config
  UV_VERSION: 0.5
  PYTHON_VERSION: 3.11
  UV_LINK_MODE: copy
  UV_FROZEN: true

.base_job_template: &base_job_template
  retry:
    max: 2
    when:
      - runner_system_failure
  tags:
    - "k8s_runner_persionnel_matching"

include:
  - template: Security/Secret-Detection.gitlab-ci.yml

secret_detection:
  rules:
    - if: "$CI_COMMIT_MESSAGE =~ /^v/ || $CI_COMMIT_TAG"
      when: never
    - if: "$CI_COMMIT_BRANCH"

check-pre-commit:
  <<: *base_job_template 
  image: docker.io/library/python:3.11-slim
  stage: test
  rules:
    - if: "$CI_COMMIT_MESSAGE =~ /^v/ || $CI_COMMIT_TAG"
      when: never
    - if: "$CI_COMMIT_BRANCH"
  before_script:
      - |
        rm -rf /var/lib/apt/lists/* /etc/apt/sources.list.d && \
        echo 'deb https://mirrors.aliyun.com/debian/ bookworm main' > /etc/apt/sources.list && \
        echo 'deb https://mirrors.aliyun.com/debian-security/ bookworm-security main' >> /etc/apt/sources.list && \
        echo 'deb https://mirrors.aliyun.com/debian/ bookworm-updates main' >> /etc/apt/sources.list && \
        apt-get update
      - apt-get install -y --no-install-recommends git
  script:
    - pip install pre-commit -i https://pypi.org/simple
    - pre-commit run --all-files
